-- ================================================================================
-- Simple Blog Database
-- ================================================================================
-- Phase 3: MySQL基礎編 - 総合プロジェクト1
--
-- このSQLファイルは、ブログシステムのデータベースを作成します。
-- phpMyAdminのSQLタブで実行してください。
-- ================================================================================

-- ================================================================================
-- データベースの作成
-- ================================================================================

-- 既存のデータベースを削除（注意：既存データが削除されます）
DROP DATABASE IF EXISTS blog_db;

-- データベースを作成（文字コード：utf8mb4）
CREATE DATABASE blog_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 作成したデータベースを使用
USE blog_db;

-- ================================================================================
-- テーブルの作成
-- ================================================================================

-- ユーザーテーブル
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT 'ユーザーID',
    username VARCHAR(50) UNIQUE NOT NULL COMMENT 'ユーザー名（一意）',
    email VARCHAR(255) UNIQUE NOT NULL COMMENT 'メールアドレス（一意）',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '登録日時'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ユーザー情報';

-- カテゴリテーブル
CREATE TABLE categories (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT 'カテゴリID',
    name VARCHAR(100) UNIQUE NOT NULL COMMENT 'カテゴリ名（一意）'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='カテゴリ情報';

-- 投稿テーブル
CREATE TABLE posts (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '投稿ID',
    user_id INT NOT NULL COMMENT 'ユーザーID（外部キー）',
    category_id INT NOT NULL COMMENT 'カテゴリID（外部キー）',
    title VARCHAR(200) NOT NULL COMMENT '投稿タイトル',
    content TEXT NOT NULL COMMENT '投稿本文',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '投稿日時',

    -- 外部キー制約
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (category_id) REFERENCES categories(id) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ブログ投稿';

-- ================================================================================
-- サンプルデータの挿入
-- ================================================================================

-- ユーザーデータの挿入
INSERT INTO users (username, email) VALUES
('taro', 'taro@example.com'),
('hanako', 'hanako@example.com'),
('jiro', 'jiro@example.com');

-- カテゴリデータの挿入
INSERT INTO categories (name) VALUES
('技術'),
('ライフスタイル'),
('旅行'),
('料理'),
('音楽');

-- 投稿データの挿入
INSERT INTO posts (user_id, category_id, title, content) VALUES
-- 太郎さんの投稿（技術カテゴリ）
(1, 1, 'PHP入門', 'PHPの基礎について学びました。変数、配列、関数など、基本的な文法を理解することが重要です。'),
(1, 1, 'MySQL基礎', 'データベースの基本を学んでいます。テーブル設計や正規化について理解を深めています。'),
(1, 1, 'データベース設計のコツ', '良いデータベース設計のポイントは、データの重複を避け、適切な関連付けを行うことです。'),

-- 花子さんの投稿（ライフスタイル、旅行、音楽）
(2, 2, '朝のルーティン', '毎朝6時に起きて、ヨガと瞑想をしています。健康的な生活習慣を心がけています。'),
(2, 3, '京都旅行記', '先週末に京都を訪れました。清水寺や金閣寺を観光し、美しい日本の伝統文化に触れることができました。'),
(2, 5, 'お気に入りの音楽', '最近はジャズを聴いています。リラックスできる音楽は仕事の効率も上げてくれます。'),

-- 次郎さんの投稿（料理、ライフスタイル）
(3, 4, '簡単パスタレシピ', 'トマトソースのパスタを作りました。シンプルですが美味しく仕上がりました。'),
(3, 2, '読書習慣の作り方', '毎日30分の読書を習慣にしています。継続することで、知識が積み重なっていくのを実感しています。');

-- ================================================================================
-- データの確認
-- ================================================================================

-- 全ユーザーを表示
SELECT * FROM users;

-- 全カテゴリを表示
SELECT * FROM categories;

-- 全投稿を表示
SELECT * FROM posts;

-- ================================================================================
-- 実践的なクエリ例
-- ================================================================================

-- 例1: 特定のユーザー（taro）の投稿を取得
SELECT * FROM posts WHERE user_id = 1;

-- 例2: 特定のカテゴリ（技術）の投稿を取得
SELECT * FROM posts WHERE category_id = 1;

-- 例3: 最新の5件の投稿を取得
SELECT * FROM posts ORDER BY created_at DESC LIMIT 5;

-- 例4: タイトルに「PHP」を含む投稿を検索
SELECT * FROM posts WHERE title LIKE '%PHP%';

-- 例5: 投稿数をカウント
SELECT COUNT(*) AS total_posts FROM posts;

-- ================================================================================
-- データの更新例
-- ================================================================================

-- 例1: ユーザーのメールアドレスを更新
-- UPDATE users SET email = 'newtaro@example.com' WHERE username = 'taro';

-- 例2: 投稿のタイトルを更新
-- UPDATE posts SET title = 'PHP入門 - 基礎編' WHERE id = 1;

-- 例3: カテゴリ名を更新
-- UPDATE categories SET name = 'テクノロジー' WHERE name = '技術';

-- ================================================================================
-- データの削除例
-- ================================================================================

-- 例1: 特定の投稿を削除
-- DELETE FROM posts WHERE id = 1;

-- 例2: 特定のユーザーの全投稿を削除
-- DELETE FROM posts WHERE user_id = 3;

-- 注意: 外部キー制約があるため、参照されているデータは削除できません
-- 例: usersテーブルのユーザーを削除する前に、そのユーザーの投稿を削除する必要があります

-- ================================================================================
-- テーブル構造の確認
-- ================================================================================

-- usersテーブルの構造を確認
DESCRIBE users;

-- categoriesテーブルの構造を確認
DESCRIBE categories;

-- postsテーブルの構造を確認
DESCRIBE posts;

-- ================================================================================
-- 外部キー制約の確認
-- ================================================================================

-- postsテーブルの外部キー制約を確認
SHOW CREATE TABLE posts;

-- ================================================================================
-- 注意事項
-- ================================================================================

-- 1. 外部キー制約について
--    - ON DELETE CASCADE: 親レコード（users）が削除されると、子レコード（posts）も自動削除
--    - ON DELETE RESTRICT: 親レコード（categories）が削除される際、子レコード（posts）が存在すると削除不可
--
-- 2. 文字コード設定
--    - utf8mb4: 絵文字や特殊文字にも対応した文字コード
--    - utf8mb4_unicode_ci: 大文字小文字を区別しない照合順序
--
-- 3. データベースエンジン
--    - InnoDB: トランザクションと外部キー制約をサポート
--
-- 4. コメント
--    - COMMENT句でテーブルやカラムに説明を追加（ドキュメントとして有用）

-- ================================================================================
-- 実践課題のヒント
-- ================================================================================

-- 課題2: データの挿入
-- ヒント: INSERT INTO テーブル名 (カラム1, カラム2, ...) VALUES (値1, 値2, ...);

-- 課題3: データの更新
-- ヒント: UPDATE テーブル名 SET カラム名 = 新しい値 WHERE 条件;
-- 注意: WHERE句を忘れると全レコードが更新されます！

-- 課題4: データの削除
-- ヒント: DELETE FROM テーブル名 WHERE 条件;
-- 注意: WHERE句を忘れると全レコードが削除されます！

-- 課題5: 高度なクエリ
-- ヒント: ORDER BY で並び替え、LIMIT で件数制限
-- 例: SELECT * FROM posts ORDER BY created_at DESC LIMIT 5;

# Lesson 02: セッション管理 - 演習問題 💪

セッション管理とセキュアなログイン機能の実装を練習しよう！

---

## 🌱 基礎編（必須）

### 演習 02-01: セッション変数の基本

**課題**：

セッション変数に名前を保存し、別のページで表示するプログラムを作ろう。

**ファイル構成**：

```text
02-01-session-save.php   ← 名前を保存
02-01-session-show.php   ← 名前を表示
```

**要件**：

- フォームで名前を入力
- セッションに保存
- 別のページで「ようこそ、〇〇さん」と表示
- XSS対策として `htmlspecialchars()` を使う

👉 **[解答例を見る](solutions/README.md#演習-02-01-セッション変数の基本)**

---

### 演習 02-02: ログインチェック機能

**課題**：

ログインしていないとアクセスできないページを作ろう。

**ファイル構成**：

```text
02-02-login.php       ← ログインフォーム
02-02-protected.php   ← ログイン済みユーザーのみアクセス可能
02-02-logout.php      ← ログアウト処理
```

**要件**：

- ログインフォームでユーザー名とパスワードを入力
- **簡易版**：ユーザー名 = "admin"、パスワード = "password123" で固定
- ログイン成功時、セッションに保存し、`session_regenerate_id(true)` を実行
- `protected.php` でログインチェック（ログインしていない場合はリダイレクト）
- ログアウト機能（セッション破棄）

👉 **[解答例を見る](solutions/README.md#演習-02-02-ログインチェック機能)**

---

## 🚀 応用編（推奨）

### 演習 02-03: ユーザー登録とログイン機能

**課題**：

ユーザー登録機能とログイン機能を実装しよう。

**ファイル構成**：

```text
02-03-register.php   ← ユーザー登録
02-03-login.php      ← ログイン
02-03-dashboard.php  ← ダッシュボード
02-03-logout.php     ← ログアウト
```

**要件**：

- ユーザーデータは `data/users.json` に保存
- パスワードは `password_hash()` でハッシュ化
- ログイン時に `password_verify()` で検証
- ログイン成功時に `session_regenerate_id(true)` を実行
- ダッシュボードでログインチェック

👉 **[解答例を見る](solutions/README.md#演習-02-03-ユーザー登録とログイン機能)**

---

### 演習 02-04: セッションタイムアウト機能

**課題**：

最後のアクティビティから15分経過したら、自動的にログアウトする機能を実装しよう。

**要件**：

- `$_SESSION['last_activity']` にタイムスタンプを保存
- 毎回アクセス時に経過時間をチェック
- 15分（900秒）経過していたら、セッションを破棄してログインページへリダイレクト
- タイムアウト後は「セッションがタイムアウトしました」と表示

👉 **[解答例を見る](solutions/README.md#演習-02-04-セッションタイムアウト機能)**

---

## 🔒 セキュリティチャレンジ（超重要！）

### 演習 02-05: セッションハイジャック脆弱性の修正

**課題**：

以下の**脆弱なコード**を修正して、セキュアにしよう。

**脆弱なコード**（login.php）：

```php
<?php
session_start();

$username = $_POST['username'];
$password = $_POST['password'];

if ($username === "admin" && $password === "password123") {
    // 🚨 session_regenerate_id() が無い！
    $_SESSION['user_id'] = 1;
    $_SESSION['username'] = $username;
    header('Location: dashboard.php');
    exit;
}
?>
```

**修正要件**：

1. `session_regenerate_id(true)` を追加
2. パスワードのハッシュ化（password_hash/password_verify）
3. XSS対策（htmlspecialchars）
4. エラーハンドリング

👉 **[解答例を見る](solutions/README.md#演習-02-05-セッションハイジャック脆弱性の修正)**

---

### 演習 02-06: パスワード平文保存の修正

**課題**：

以下の**危険なコード**を修正して、セキュアにしよう。

**危険なコード**（register.php）：

```php
<?php
// 🚨 超危険：パスワードを平文で保存
$username = $_POST['username'];
$password = $_POST['password'];

$user = ['username' => $username, 'password' => $password];
file_put_contents('data/users.json', json_encode($user));

echo "登録完了！";
?>
```

**修正要件**：

1. `password_hash()` でパスワードをハッシュ化
2. 既存ユーザーの重複チェック
3. バリデーション（空欄チェック、パスワード長チェック）
4. JSON形式で複数ユーザーを保存できるようにする

👉 **[解答例を見る](solutions/README.md#演習-02-06-パスワード平文保存の修正)**

---

## 🏆 総合チャレンジ（任意）

### 演習 02-07: 会員制サイトの構築

**課題**：

ユーザー登録・ログイン・ログアウト・プロフィール編集機能を持つ、会員制サイトを作ろう！

**機能**：

1. **ユーザー登録**：ユーザー名、メールアドレス、パスワード
2. **ログイン**：メールアドレスとパスワードで認証
3. **ログアウト**：セッション破棄
4. **ダッシュボード**：ログイン済みユーザーのみアクセス可能
5. **プロフィール編集**：ユーザー名とメールアドレスを変更
6. **セッションタイムアウト**：30分

**セキュリティ要件**：

- パスワードのハッシュ化
- session_regenerate_id() の使用
- ログインチェック
- XSS対策
- セッションタイムアウト

👉 **[解答例を見る](solutions/README.md#演習-02-07-会員制サイトの構築)**

---

## 🎯 演習を終えたら

### 自己チェックリスト

- [ ] セッションの開始（session_start）ができる
- [ ] セッション変数の保存・取得・削除ができる
- [ ] ログイン機能を実装できる
- [ ] ログアウト機能を実装できる
- [ ] **session_regenerate_id()** を適切に使える
- [ ] **password_hash()** でパスワードをハッシュ化できる
- [ ] **password_verify()** でパスワードを検証できる
- [ ] ログインチェック機能を実装できる
- [ ] セッションタイムアウトを実装できる

---

**Let's vibe and code! 🎉**

セッション管理をマスターして、セキュアなログイン機能を実装できるようになったね！✨
